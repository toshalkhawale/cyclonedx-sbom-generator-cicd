#!/bin/bash

# Script to check for vulnerabilities in a CycloneDX SBOM
# This demonstrates how to use Grype with CycloneDX SBOMs

set -e

echo "Starting vulnerability check for SBOM..."

# Create output directory
mkdir -p vulnerability-reports

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Install Grype if not already installed
install_grype() {
  if ! command_exists grype; then
    echo "Installing Grype..."
    curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
  fi
}

# Check vulnerabilities in a SBOM file
check_vulnerabilities() {
  local sbom_file=$1
  local output_file=$2
  
  echo "Checking vulnerabilities in SBOM: $sbom_file"
  
  # Use Grype to check for vulnerabilities
  grype sbom:$sbom_file -o json > "$output_file"
  
  # Also display a summary in the terminal
  echo "Vulnerability summary:"
  grype sbom:$sbom_file
  
  echo "Vulnerability report generated: $output_file"
}

# Main execution
install_grype

# Check if SBOM file is provided as argument
if [ $# -eq 0 ]; then
  echo "No SBOM file provided. Looking for SBOMs in sbom-output directory..."
  
  # Check if sbom-output directory exists
  if [ -d "sbom-output" ]; then
    # Find all JSON SBOMs in the directory
    for sbom_file in sbom-output/*.json; do
      if [ -f "$sbom_file" ]; then
        output_file="vulnerability-reports/$(basename "$sbom_file" .json)-vulnerabilities.json"
        check_vulnerabilities "$sbom_file" "$output_file"
      fi
    done
  else
    echo "sbom-output directory not found. Please run generate-sbom.sh first."
    exit 1
  fi
else
  # Use the provided SBOM file
  sbom_file=$1
  if [ -f "$sbom_file" ]; then
    output_file="vulnerability-reports/$(basename "$sbom_file" .json)-vulnerabilities.json"
    check_vulnerabilities "$sbom_file" "$output_file"
  else
    echo "SBOM file not found: $sbom_file"
    exit 1
  fi
fi

echo "Vulnerability check complete! Reports are available in the vulnerability-reports directory."
